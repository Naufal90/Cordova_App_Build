name: Build Android APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: '17'  # Kembali ke Java 11 untuk kompatibilitas
        distribution: 'temurin'
        
    - name: Install Cordova with compatible version
      run: |
        npm install -g cordova@12.0.0
        cordova --version
        
    - name: Clean previous builds
      run: |
        rm -rf platforms/
        rm -rf plugins/
        
    - name: Add Android platform with compatible version
      run: |
        cordova platform add android@12.0.0  # Update ke versi yang match dengan Cordova 12
        
    - name: Fix XmlParser compatibility issue
      run: |
        # Fix untuk XmlParser yang deprecated
        cat > fix_xmlparser.js << 'EOF'
        const fs = require('fs');
        const path = require('path');
        
        const cordovaGradlePath = path.join('platforms', 'android', 'CordovaLib', 'cordova.gradle');
        
        if (fs.existsSync(cordovaGradlePath)) {
            console.log('ðŸ”§ Fixing XmlParser in cordova.gradle...');
            let content = fs.readFileSync(cordovaGradlePath, 'utf8');
            
            // Replace XmlParser dengan XmlSlurper
            content = content.replace(/new XmlParser\(false, false\)/g, 'new XmlSlurper()');
            content = content.replace(/XmlParser\(\)/g, 'XmlSlurper()');
            
            fs.writeFileSync(cordovaGradlePath, content, 'utf8');
            console.log('âœ… Fixed XmlParser to XmlSlurper');
        }
        EOF
        node fix_xmlparser.js
        
    - name: Fix Android build compatibility
      run: |
        # Update app build.gradle untuk kompatibilitas
        cat > fix_build.gradle << 'EOF'
        android {
            compileSdkVersion 34
            buildToolsVersion "33.0.2"
            namespace 'com.n90.myinput.app'
            
            compileOptions {
                sourceCompatibility JavaVersion.VERSION_17
                targetCompatibility JavaVersion.VERSION_17
            }
            
            defaultConfig {
                minSdkVersion 26
                targetSdkVersion 34
            }
        }
        EOF
        
        # Apply the fix to app build.gradle
        if [ -f "platforms/android/app/build.gradle" ]; then
            cat fix_build.gradle >> platforms/android/app/build.gradle
            echo "âœ… Applied Android build compatibility fix"
        fi
        
    - name: Set environment variables for compatibility
      run: |
        echo "ORG_GRADLE_PROJECT_cdvCompileSdkVersion=34" >> $GITHUB_ENV
        echo "ORG_GRADLE_PROJECT_cdvTargetSdkVersion=34" >> $GITHUB_ENV
        echo "ORG_GRADLE_PROJECT_cdvMinSdkVersion=26" >> $GITHUB_ENV
        echo "CORDOVA_ANDROID_GRADLE_DISTRIBUTION_URL=https\\://services.gradle.org/distributions/gradle-7.5.1-all.zip" >> $GITHUB_ENV
        
    - name: Build Android Release
      run: |
        cordova build android --release -- --packageType=apk --warning-mode=none
        
    - name: Check if APK exists
      run: |
        find platforms/android/app/build/outputs/ -name "*.apk" -type f | head -5
        
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: platforms/android/app/build/outputs/apk/release/
        retention-days: 30
